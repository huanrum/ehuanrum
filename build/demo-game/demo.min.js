$ehr(!0),$ehr("../../lib/d3.js"),$ehr("$d3",function(){return window.d3}),$ehr("global",["common_dialog",function(e){var n={service:location.origin+"/ehr/game/",update:function(e,n){var t=this;return new Promise(function(n){Object.keys(e||{}).forEach(function(n){t[n]=e[n]}),Object.keys(e||{}).forEach(function(n){localStorage["[ehuanrum_game]"+n]=e[n]}),n(t)})}};return Object.keys(localStorage).forEach(function(e){/^\[ehuanrum_game\]/.test(e)&&(n[e.replace(/^\[ehuanrum_game\]/,"")]=localStorage[e])}),n}]),$ehr("http",["global","binding",function(e,n){function t(e,n){var t=Object.keys(n).sort(function(e,n){return/:/.test(n.name)-/:/.test(e.name)}).map(function(t){if(e.indexOf(":"+t)===-1)return t+"="+n[t];e=e.replace(":"+t,n[t])}).filter(function(e){return!!e}).join("&");if(e.indexOf(":")===-1)return e+(t?"?"+t:"")}return function(o,r,i){var s=t(o,r||{}),a=n(['<div class="common-dialog-back">','   <div class="common-dialog">',"      <strong [innerHTML]=\"loadMessage + '(' +floor(remaining/2)+ 's)' + index\" [hidden]=\"!remaining\"></strong>",'      <span [hidden]="!!remaining">加载已经超时</span>',"  </div>","</div>"].join(""),{loadMessage:"加载中",index:"...",remaining:60,floor:function(e){return Math.floor(e)}},document.body,function(e){var n=0,t=setInterval(function(){n=(n+1)%16,e.index=Array(n+4).join("."),e.remaining=e.remaining-1,Math.floor(e.remaining)||setTimeout(function(){a.update()},3e3)},500);e.$destroy(function(){clearInterval(t)})});return new Promise(function(n,t){var o={headers:{owner:e.user},method:i?"POST":"GET"};s||t({message:"参数不完整"}),i&&(o.body=JSON.stringify(i)),fetch(e.service+s,o).then(function(e){return a.update(),e.json()},function(e){a.update(),t(e)}).then(function(e){n(e)})})}}]),$ehr("login",["global","binding",function(e,n){var t=['<div class="login-controller">',"   <div>","       <label>UserName</label>",'       <input [value]="username">',"   </div>","   <div>","       <label>Password</label>",'       <input [value]="password">',"   </div>",'<div><button [onclick]="login(username,password)">Login</button></div>',"</div>"].join("");return function(o,r){var i=n(t,{username:r,login:function(n,t){e.update({user:n},{user:n}),i.update(),o()}},document.body)}}]),$ehr("main",["global","common.dialog",function(e,n){return function(n){e.update({OpposingFronts:e.OpposingFronts||10}),e.user?n():$ehr("login").call(this,n,"seto")}}]),$ehr("router.OpposingFronts",["binding","$d3","global","common.dialog","service.OpposingFronts",function(e,n,t,o,r){function i(){o('<ul style="max-height:400px;overflow: auto;list-style: none;"><li [op:options] style="text-align:center" @click="change(op)">{{op}}</li></ul>',{title:"选择等级挑战 "+t.OpposingFronts,options:Array(100).fill(1).map(function(e,n){return""+n}),change:function(e){t.update({OpposingFronts:e}).then(function(){window.location.reload()})}})}function s(){var e=this,n=Array.prototype.slice.call(arguments,0);return function(){var t=Array.prototype.slice.call(arguments,0);n.forEach(function(n){n.apply(e,t)})}}function a(e,n,t){var o={x:20,y:20,s:1,px:0,py:0,ps:1};return function(n){n&&(o.x=o.x+(n.x||0),o.y=o.y+(n.y||0),o.s=n.s||o.s,o.px=n.px||o.px,o.py=n.py||o.py,o.ps=n.ps||o.ps),e.attr("transform","translate("+(o.x+o.px)+","+(o.y+o.py)+") scale("+o.s*o.ps+")")}}function c(e,n,t){var o=e[0][0].parentNode.width.baseVal.value-40,r=e[0][0].parentNode.height.baseVal.value-40;return function(){var e=Math.min.apply(Math,t.nodes.map(function(e){return e.x})),i=Math.min.apply(Math,t.nodes.map(function(e){return e.y})),s=Math.max.apply(Math,t.nodes.map(function(e){return e.x})),a=Math.max.apply(Math,t.nodes.map(function(e){return e.y}));t.nodes.some(function(e){return!e.fixed})&&n.refresh({px:-e,py:-i,ps:Math.min(1,o/(s-e),r/(a-i))})}}function l(e,n,t){var o=e.selectAll("circle").data(t).enter().append("circle").attr("r",20).style("fill",function(e,n){return d3.scale.category20()(n)}).call(n.drag).on("dblclick",function(e){e.fixed=!e.fixed});return function(){o.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}}function u(e,n,t){var o=e.selectAll("line").data(t).enter().append("line").style("stroke","#ccc").style("stroke-width",2);return function(){o.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}).style("stroke",function(e){return t.some(function(n){return f(e,n)})?"#ff3636":"#36ff36"})}}function d(e,n,t){var o=e.selectAll("text").data(t).enter().append("text").style("fill","black").attr("dx",20).attr("dy",8).text(function(e){return e.name.replace(/^node\-/i,"")}).call(n.drag);return function(){o.attr("x",function(e){return e.x-30}).attr("y",function(e){return e.y})}}function f(e,n){var t=function(e,n,t){return(e.x-t.x)*(n.y-t.y)-(n.x-t.x)*(e.y-t.y)};return e.source!==n.source&&e.source!=n.target&&e.target!==n.source&&e.target!=n.target&&(!(Math.max(e.source.x,e.target.x)<Math.min(n.source.x,n.target.x))&&(!(Math.max(e.source.y,e.target.y)<Math.min(n.source.y,n.target.y))&&(!(Math.max(n.source.x,n.target.x)<Math.min(e.source.x,e.target.x))&&(!(Math.max(n.source.y,n.target.y)<Math.min(e.source.y,e.target.y))&&(!(t(n.source,e.target,e.source)*t(e.target,n.target,e.source)<0)&&!(t(e.source,n.target,n.source)*t(n.target,e.target,n.source)<0))))))}function p(e,i,s){var a=null,c={can:!1,event:null,target:null};return e.on("mousedown",function(){["circle","text","line"].indexOf(n.event.target.nodeName)===-1?(c.target=n.event.target,this.style.cursor="move"):(c.target=null,this.style.cursor="pointer")}).on("mouseup",function(){c.target||a&&a[0].parentNode||s.links.some(function(e){return s.links.some(function(n){return f(e,n)})})||r.save(s).then(function(){a=o("可以进入下一级了",{title:"提示",buttons:[function(){t.update({OpposingFronts:+t.OpposingFronts+1}).then(function(){window.location.reload()})}]})}),c.target=null,this.style.cursor="auto"}).on("mousemove",function(){c.event&&c.target&&i.refresh({x:n.event.clientX-c.event.clientX,y:n.event.clientY-c.event.clientY}),c.event=n.event}),window.document.addEventListener("keydown",function(e){if(e.altKey&&e.shiftKey&&e.ctrlKey)switch(e.key){case"S":r.save(s)}}),e}return function(o,m,g){function v(e){return function(){var n=e.links.filter(function(n){return e.links.some(function(e){return f(n,e)})}).length;n<y.score&&(y.score=n,r.score(e,n)),y.residue=n||"完成"}}var y={title:"Opposing Fronts -> "+t.OpposingFronts,residue:"**",maxscore:"**"},h=e('<div @click="selectLevel"><label>{{title}}</label><span style="color: red;font-size: 26px;margin-left: 2em;">{{residue}}</span><a>{{maxscore}}</a></div><div @click="start"></div>',y),x=n.layout.force().linkDistance(300).gravity(.03).linkStrength(1).friction(.62).charge(-600);return setTimeout(function(){r.get(+t.OpposingFronts).then(function(e){var t=p(n.select(h[1]).append("svg:svg").attr({"pointer-events":"all",width:h[1].offsetWidth-10,height:window.innerHeight-30}),x,e).append("svg:g").call(n.behavior.zoom().scaleExtent([.2,10]).scale(1).translate([0,0]).on("zoom",function(){x.refresh({s:n.event.scale})}));x.nodes(e.nodes).links(e.links),x.on("tick",s(u(t,x,e.links),l(t,x,e.nodes),d(t,x,e.nodes),c(t,x,e),v(e))),x.start(),x.refresh=a(t,x,e),y.maxscore=e.score||e.links.length,y.score=e.score||e.links.length,y.start=function(){e.nodes.forEach(function(e){e.fixed=!0})},y.selectLevel=i,setTimeout(y.start,2e3)})},100),h}}]),$ehr("service.OpposingFronts",["http","global","common.dialog",function(e,n,t){function o(o){function r(t,o,r){var c=i(o.nodes).sort(function(e,n){return e.primaryKey-n.primaryKey}),l=a(o.links,c);e(s+"/:session",{session:r}).then(function(e){t({score:e,save:!r,session:r||Date.now()+"-"+n.OpposingFronts,nodes:c,links:l})})}function i(e){return e&&e.length?e:Array(o).fill(1).map(function(e,n){return{primaryKey:n,name:"Node-"+n}})}function a(e,n){if(e&&e.length)return e;e=[];for(var t=0;t<o;t++)for(var r=t;r<o;r++)Math.random()>.9&&e.push({target:t,source:r});return e}return new Promise(function(o){e(s,{level:n.OpposingFronts}).then(function(e){var n={};e.nodes&&e.nodes.forEach(function(e){n[e.session]=!0}),Object.keys(n).length?Object.keys(n).length>1?t('<ul><li [session:sessions] @click="select(session)">{{session}}</li></ul>',{title:"选择开始结构",sessions:Object.keys(n),select:function(n){var t=function(e){return e.session===n};r(o,{nodes:e.nodes.filter(t),links:e.links.filter(t)},n),this.$close()}}):r(o,e,Object.keys(n)[0]):r(o,e)})})}function r(n){return n.save?(n.save=!1,e(s,{},{nodes:n.nodes.map(function(e){return{orderIndex:e.primaryKey,name:e.name,session:n.session}}),links:n.links.map(function(e){return{target:e.target.primaryKey,source:e.source.primaryKey,session:n.session}})})):Promise.resolve()}function i(n,t){return e(s+"/:session",{session:n.session},{value:t})}var s="OpposingFronts";return{get:o,save:r,score:i}}]),$ehr("control.my.form",["binding","value","common_dialog",function(e,n,t){return function(t,o,r){var i=o.$extend({},[r]);Object.defineProperty(i,"fields",{configurable:!0,enumerable:!1,get:function(){return Object.keys(n(o,r))}}),e(['   <div class="form-body">','       <div [field:fields] class="form-row" [my.label.value]="'+r+':field">',"       </div>","   </div>"].join(""),i,t)}}]),$ehr("control.my.label.value",["binding",function(e){return function(n,t,o){var r=t.$extend({},o.split(":"));e(['   <div class="label-value">','       <label [innerHTML]="field"></label>','       <div [innerHTML]="item[field]|lookup(field)"></div>',"   </div>"].join("").replace(/item/g,o.split(":")[0]).replace(/field/g,o.split(":")[1]),r,n)}}]),$ehr("common.dialog",["binding",function(e){function n(e,n){function t(e){var t=window.getComputedStyle(n);r.e=e,r.x=e.clientX-(parseInt(t.left)||0),r.y=e.clientY-(parseInt(t.top)||0),n.style.cursor="move",window.addEventListener("mousemove",o)}function o(e){n.style.left=e.clientX-r.x+"px",n.style.top=e.clientY-r.y+"px"}var r={};e.addEventListener("mousedown",function(e){var o=window.getComputedStyle(n);(e.clientX<(parseInt(o.left)||0)+(parseInt(o.width)||0)-15||e.clientY<(parseInt(o.top)||0)+(parseInt(o.height)||0)-15)&&t(e)}),window.addEventListener("mouseup",function(){r.e=null,n.style.cursor="default",window.removeEventListener("mousemove",o)})}return function(t,o){o=o||{},o.buttons=o.buttons||[],o.$close=function(){r.update()};var r=e([' <div class="common-dialog-back">','   <div class="common-dialog" [style.background]="background">','       <div class="common-dialog-header">',"           <label>",o.title||"no title","           </label>",'           <a [onclick]="$close">&times;</a>',"       </div>",'       <div class="common-dialog-content">',t,"       </div>",'       <div class="common-dialog-footer">','           <a [btn:buttons] [onclick]="btn" [innerHTML]="btn.name"></a>',"       </div>","   </div>"," </div>"].join(""),o,document.body);return r.forEach(function(e){n(e.getElementsByClassName("common-dialog-header")[0],e.getElementsByClassName("common-dialog")[0])}),r}}]),$ehr("filter.capitalize",function(){return function(e,n){return n=n%e.length||0,e.slice(0,n)+e[n].toLocaleUpperCase()+e.slice(n+1)}});